{# item_contrato/detail.html #}
{% extends 'contracts/base.html' %}
{% load math_extras %}
{% block content %}

<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-semibold mb-4">Detalhes do Item de Contrato</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div><strong>Contrato:</strong><p>{{ item.contrato.numero_contrato }} - {{ item.contrato.cliente.nome_fantasia }}</p></div>
        <div><strong>Nº do Item:</strong><p>{{ item.numero_item }}</p></div>
        <div><strong>Lote:</strong><p>{{ item.lote|default:"-" }}</p></div>
        <div class="md:col-span-2"><strong>Descrição:</strong><p>{{ item.descricao }}</p></div>
        <div><strong>Tipo:</strong><p>{{ item.tipo }}</p></div>
        <div><strong>Unidade:</strong><p>{{ item.unidade }}</p></div>
        <div><strong>Quantidade:</strong><p>{{ item.quantidade }}</p></div>
        <div><strong>Valor Unitário (R$):</strong><p>{{ item.valor_unitario|currency_br }}</p></div>
        <div><strong>Valor Total (R$):</strong><p>{{ item.valor_total|currency_br }}</p></div>
        {% if item.tipo in 'Hardware,Software,Solução' %}
        <div><strong>Vigência Produto (meses):</strong><p>{{ item.vigencia_produto }}</p></div>
        {% endif %}
        <div><strong>Quantidade Consumida:</strong><p>{{ item.quantidade_consumida }}</p></div>
        <div><strong>Saldo de Quantidade:</strong><p>{{ item.saldo_quantidade }}</p></div>
        <div><strong>Valor Faturado (R$):</strong><p>{{ item.valor_faturado|currency_br }}</p></div>
        <div><strong>Valor Saldo (R$):</strong><p>{{ item.valor_saldo|currency_br }}</p></div>
    </div>

    <!-- Histórico de Consumo -->
    <h2 class="text-xl font-semibold mb-2 mt-8">Histórico de Consumo</h2>

    {% if item.tipo in 'Hardware,Software,Solução' %}
        {% with ordens=item.ordemfornecimento_set.all %}
            {% if ordens %}
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto border border-gray-300 dark:border-gray-600">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border px-4 py-2">Nº OF</th>
                                <th class="border px-4 py-2">Unidade</th>
                                <th class="border px-4 py-2">Quantidade</th>
                                <th class="border px-4 py-2">Valor Unitário (R$)</th>
                                <th class="border px-4 py-2">Valor Total (R$)</th>
                                <th class="border px-4 py-2">Vigência Restante (meses)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ordem in ordens %}
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="border px-4 py-2">{{ ordem.numero_os_of }}</td>
                                    <td class="border px-4 py-2">{{ ordem.unidade }}</td>
                                    <td class="border px-4 py-2">{{ ordem.quantidade }}</td>
                                    <td class="border px-4 py-2">{{ ordem.valor_unitario|currency_br }}</td>
                                    <td class="border px-4 py-2">{{ ordem.valor_total|currency_br }}</td>
                                    <td class="border px-4 py-2">
                                        {% if ordem.data_ativacao %}
                                            {{ item.vigencia_restante }} meses
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Não há Ordens de Fornecimento vinculadas.</p>
            {% endif %}
        {% endwith %}
    {% else %}
        {% with ordens=item.ordemservico_set.all %}
            {% if ordens %}
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto border border-gray-300 dark:border-gray-600">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border px-4 py-2">Nº OS</th>
                                <th class="border px-4 py-2">Unidade</th>
                                <th class="border px-4 py-2">Quantidade</th>
                                <th class="border px-4 py-2">Valor Unitário (R$)</th>
                                <th class="border px-4 py-2">Valor Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ordem in ordens %}
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="border px-4 py-2">{{ ordem.numero_os_of }}</td>
                                    <td class="border px-4 py-2">{{ ordem.unidade }}</td>
                                    <td class="border px-4 py-2">{{ ordem.quantidade }}</td>
                                    <td class="border px-4 py-2">{{ ordem.valor_unitario|currency_br }}</td>
                                    <td class="border px-4 py-2">{{ ordem.valor_total|currency_br }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Não há Ordens de Serviço vinculadas.</p>
            {% endif %}
        {% endwith %}
    {% endif %}

    <!-- Botões -->
    <div class="flex justify-between mt-6">
        <a href="{% url 'gestao_contratos_detail' item.contrato.pk %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Voltar ao Contrato</a>
        <div class="flex gap-2">
            <a href="{% url 'item_contrato_update' item.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Editar</a>
            <a href="{% url 'item_contrato_delete' item.id %}" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Excluir</a>
        </div>
    </div>
</div>

{% endblock %}
